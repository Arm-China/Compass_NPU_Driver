# Samples for UMD

The samples can quickly verify the functionality of the whole UMD and KMD logic. They can be split into two parts, one is for simulation environmetn, another is for HW environment.

## 1. For simulator verification
- simulation_test: this case is for aipu v1/v2.

```bash
# ./aipu_simulation_test -s aipu_simulator_[x1|z1|z2|z3] -b aipu.bin -i input0.bin -c output.bin -d ./

eg:
-s aipu_simulator_x1
```

- v3_simulation_test: this case is only for aipu v3.

```bash
# ./aipu_v3_simulation_test -b aipu.bin -i input0.bin -c output.bin -d ./
```

note:
- aipu.bin,input.bin and output.bin are some necessary files generated by specific buildtool(NN-Compiler).
- These cases only use UMD source code, don't need KMD part.
- Add the library of UMD to LD_LIBRARY_PATH.

## 2. For HW verifcation
- benchmark_test: a general case run on HW board.
```bash
# ./aipu_benchmark_test -b aipu.bin -i input0.bin -c output.bin -d ./
```

- mthread_test: create two thread to run different inference jobs.
```bash
# ./aipu_mthread_test [-p] -b aipu.bin -i input0.bin -c output.bin -d ./
```

- flush_job_test: create multiple inference jobs firstly, then get their result one by one.
```bash
# ./aipu_flush_job_test -b aipu.bin -i input0.bin -c output.bin -d ./
```

- profiler_test: can dump profiling data if enable profile feature, only for aipu v1/v2.
```bash
# ./aipu_profiler_test -b aipu.bin -i input0.bin -c output.bin -d ./
```

- multi_model_test: load multiple models and dispatch them to different core, only for aipu v3.
```bash
# ./aipu_multi_model_test -b aipu.bin -i input0.bin -c output.bin -d ./
```

- batch_test: load multiple input frames for one model, try to parallel frames on cores. only for aipu v3.
```bash
# ./aipu_batch_test -b aipu.bin -i input0.bin -c output.bin -d ./
```

- sharebuffer_test: share some input/output buffers between graphs in one process.
```bash
# ./aipu_sharebuffer_test -b aipu.bin -i input0.bin -c output.bin -d ./
```

- dmabuf_mmap_test: asscess dma_buf via mmap in user mode
```bash
# ./aipu_dmabuf_mmap_test -b aipu.bin -i input0.bin -c output.bin -d ./
```

- dmabuf_vmap_test: access dma_buf via vmap in kernel mode and mmap in user mode
```bash
# insmod importer.ko
# ./aipu_dmabuf_vmap_test
```

- dmabuf_dma_test: access dma_buf via DMA HW in kernel mode and mmap in user mode
```bash
# insmod importer.ko
# ./aipu_dmabuf_vmap_test
```

note:
- These cases will cover both UMD and KMD part.
- Add the path of UMD library to LD_LIBRARY_PATH.
- When utilizing dma_buf mechanism, it has to confirm the input or output tensor buffer
  as independent one, they can't be shared with other intermidiate tensor buffers
  on generating model binary. To get independent input or output tensor buffer in
  model binary, it needs to specify specific parameters: '--disable_input_buffer_reuse'
  and '--disable_output_buffer_reuse' to NN Compiler graph builder(aipugb).

  Example 1: generate independent input tensor buffer in model binary
  aipugb graph.def -w weight.bin --disable_input_buffer_reuse --target X2_1204 -o aipu.bin

  Example 2: generate independent input and output tensor buffer in model binary
  aipugb graph.def -w weight.bin --disable_input_buffer_reuse --disable_output_buffer_reuse \
  --target X2_1204 -o aipu.bin